<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: routes/stt.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: routes/stt.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Manages some deepspeech utilities functions
 * @author Aurélie Beaugeard
*/

/**
 * @import { isEmpty } from "./routes/index.js"
 * @see {@link "./routes/index.js"|index.js}
 */
import { isEmpty } from './index.js'

const DeepSpeech = require('deepspeech')

/**
 * Function that returns the transcription of an audioBuffer using deepspeech node.
 *
 * @param {Buffer} audioBuffer The audioBuffer to be transcripted (parameters to be verified : mono-channel,16000 Hz (sample rate), 16 bit PCM)
 * @param {DeepSpeech.Model} model The deepspeech model used to convert the speech to text
 * @returns {String} The text message from the user
 * @see {@link https://deepspeech.readthedocs.io/en/v0.7.4/NodeJS-API.html|DeepSpeech}
 */
function speechToText (audioBuffer, model) {
  const result = model.stt(audioBuffer)

  return result
}

/**
 * Function that returns a pre-constructed DeepSpeech Model object
 *
 * @description DEEPSPEECH VERSION: 0.7.4,
 * @description BEAM_WIDTH: 1024,
 * @description LM_ALPHA: 0.75,
 * @description LM_BETA: 1.85,
 * @see {@link https://deepspeech.readthedocs.io/en/v0.7.4/NodeJS-API.html|DeepSpeech}
 * @returns {DeepSpeech.Model} The model to be used for the transcription
 */
export function loadDeepSpeechModel () {
  const modelPath = './models/deepspeech-0.8.0-models.pbmm'

  const model = new DeepSpeech.Model(modelPath)
  model.setBeamWidth(global.config.BEAM_WIDTH)

  const scorerPath = './models/deepspeech-0.8.0-models.scorer'

  model.enableExternalScorer(scorerPath)
  model.setScorerAlphaBeta(global.config.LM_ALPHA, global.config.LM_BETA)

  return model
}

/**
 * Function that manages the post request from the stt service
 * @param {Request} req the received request from the voice-assistant service
 * @param {Response} res the response in json format
 * @param {DeepSpeech.Model} model the DeepSppech model to make the speech to text transcription
 */
export function executeSpeechToTextRequest (req, res, model) {
  // If we receive an empty buffer or an undefined object we send back an error to the voice assistant service.
  if (isEmpty(req.body)) {
    res.status(400).json({ status: 'fail', message: 'The request body contains nothing' })
  } else {
    const buffer = Buffer.from(req.body, 'base64')
    const textMessage = speechToText(buffer, model)

    console.log('Text message :', textMessage)

    // If deepspeech transcription is empty we send back an error to the voice assistant service.
    if (textMessage.length === 0) {
      res.status(400).json({ status: 'fail', service: 'Speech To Text service', message: 'no transcription for this' })
    } else {
      // Everything is fine, we send back the textMessage
      res.status(200).json({ status: 'ok', text: textMessage })
    }
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#executeSpeechToTextRequest">executeSpeechToTextRequest</a></li><li><a href="global.html#Gettingservicestatus">Getting service status</a></li><li><a href="global.html#Gettingthetestresult">Getting the test result</a></li><li><a href="global.html#isEmpty">isEmpty</a></li><li><a href="global.html#loadDeepSpeechModel">loadDeepSpeechModel</a></li><li><a href="global.html#sampleData">sampleData</a></li><li><a href="global.html#Speech-To-Texttranscriptionpost">Speech-To-Text transcription post</a></li><li><a href="global.html#speechToText">speechToText</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.5</a> on Mon Aug 03 2020 14:01:06 GMT+0200 (heure d’été d’Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
